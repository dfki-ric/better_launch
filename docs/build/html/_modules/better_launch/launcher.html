

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>better_launch.launcher &mdash; better_launch 0.9.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
    <link rel="shortcut icon" href="../../_static/logo.svg"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=9dc39874"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            better_launch
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../better_launch_custom.html">better_launch package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">better_launch</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">better_launch.launcher</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for better_launch.launcher</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.node</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Node</span> <span class="k">as</span> <span class="n">RosNode</span><span class="p">,</span>
    <span class="n">Service</span> <span class="k">as</span> <span class="n">RosServiceProvider</span><span class="p">,</span>
    <span class="n">Client</span> <span class="k">as</span> <span class="n">RosServiceClient</span><span class="p">,</span>
    <span class="n">Publisher</span> <span class="k">as</span> <span class="n">RosPublisher</span><span class="p">,</span>
    <span class="n">Subscription</span> <span class="k">as</span> <span class="n">RosSubscriber</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.qos</span><span class="w"> </span><span class="kn">import</span> <span class="n">QoSProfile</span><span class="p">,</span> <span class="n">qos_profile_services_default</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ament_index_python.packages</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_package_prefix</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># Surprisingly large imports, so we only import them if we actually need them</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.action</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">ActionServer</span> <span class="k">as</span> <span class="n">RosActionServer</span><span class="p">,</span>
        <span class="n">ActionClient</span> <span class="k">as</span> <span class="n">RosActionClient</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># For anonymous nodes</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">wonderwords</span>

    <span class="n">_uuid_generator</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">g</span><span class="o">=</span><span class="n">wonderwords</span><span class="o">.</span><span class="n">RandomWord</span><span class="p">(</span>
        <span class="n">exclude_with_spaces</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span> <span class="n">g</span><span class="o">.</span><span class="n">word</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

    <span class="n">_uuid_generator</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">better_launch.elements</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Group</span><span class="p">,</span>
    <span class="n">AbstractNode</span><span class="p">,</span>
    <span class="n">Node</span><span class="p">,</span>
    <span class="n">Composer</span><span class="p">,</span>
    <span class="n">Component</span><span class="p">,</span>
    <span class="n">LifecycleStage</span><span class="p">,</span>
    <span class="n">Ros2LaunchWrapper</span><span class="p">,</span>
    <span class="n">ForeignNode</span><span class="p">,</span>
    <span class="n">get_package_for_path</span><span class="p">,</span>
    <span class="n">find_process_for_node</span><span class="p">,</span>
    <span class="n">find_foreign_nodes</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">better_launch.utils.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">default_substitution_handlers</span><span class="p">,</span>
    <span class="n">substitute_tokens</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">better_launch.utils.introspection</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">find_function_frame</span><span class="p">,</span>
    <span class="n">find_calling_frame</span><span class="p">,</span>
    <span class="n">find_launchthis_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">better_launch.utils.better_logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogSink</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">better_launch.ros.ros_adapter</span><span class="w"> </span><span class="kn">import</span> <span class="n">ROSAdapter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">better_launch.ros</span><span class="w"> </span><span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">roslog</span>


<span class="n">_bl_singleton_instance</span> <span class="o">=</span> <span class="s2">&quot;__better_launch_instance&quot;</span>
<span class="n">_bl_include_args</span> <span class="o">=</span> <span class="s2">&quot;__better_launch_include_args&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_BetterLaunchMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="n">_singleton_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>

    <span class="c1"># Allows (and enforces) reusing an already existing BetterLaunch instance.</span>
    <span class="c1"># Important for launch file includes.</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">existing_instance</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_bl_singleton_instance</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">existing_instance</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">_bl_singleton_instance</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_singleton_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">instance</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BetterLaunch&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Immediately retrieve the BetterLaunch singleton instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        BetterLaunch</span>
<span class="sd">            The BetterLaunch singleton instance, or None if it doesn&#39;t exist yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_singleton_future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_instance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BetterLaunch&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the BetterLaunch singleton instance as soon as possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            How long to wait for the singleton instance to appear. Wait forever if timeout is None. Don&#39;t wait at all if timeout is 0.0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        BetterLaunch</span>
<span class="sd">            The BetterLaunch singleton instance.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            If the timeout has passed and no instance has appeared yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_singleton_future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>


<div class="viewcode-block" id="BetterLaunch">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BetterLaunch</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">_BetterLaunchMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This should be all you need to create beautiful, simple and convenient launch files!&quot;&quot;&quot;</span>

    <span class="n">_launchfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_launch_func_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="BetterLaunch.__init__">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">launch_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">root_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Note that BetterLaunch is a singleton: only the first invocation to `__init__` will succeed. All subsequent calls will return the previous instance. If you need access to the BetterLaunch instance outside your launch function, consider using one of the following classmethods instead:</span>
<span class="sd">        * :py:meth:`BetterLaunch.instance &lt;_BetterLaunchMeta.instance&gt;`</span>
<span class="sd">        * :py:meth:`BetterLaunch.wait_for_instance &lt;_BetterLaunchMeta.wait_for_instance&gt;`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of this instance, will default to the launchfile&#39;s filename.</span>
<span class="sd">        launch_args : dict, optional</span>
<span class="sd">            Override the launch arguments BetterLaunch has access to. By default this will be the launch function&#39;s arguments. These will mainly be used for passing to included launch files.</span>
<span class="sd">        root_namespace : str, optional</span>
<span class="sd">            The namespace of the root group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">BetterLaunch</span><span class="o">.</span><span class="n">_launch_func_args</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">find_calling_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
                <span class="n">BetterLaunch</span><span class="o">.</span><span class="n">_launchfile</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">BetterLaunch</span><span class="o">.</span><span class="n">_launchfile</span><span class="p">)</span>

        <span class="c1"># roslog.launch_config must be setup before instantiation of BetterLaunch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">roslog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">launch_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">BetterLaunch</span><span class="o">.</span><span class="n">_launch_func_args</span> <span class="o">=</span> <span class="n">launch_args</span>

        <span class="c1"># For those cases where we need to interact with ROS (e.g. service calls)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ros_adapter</span> <span class="o">=</span> <span class="n">ROSAdapter</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">root_namespace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_namespace</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
        <span class="n">root_namespace</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">root_namespace</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_group_root</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_namespace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_stack</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_root</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_composition_node</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Allows to run traditional ros2 launch actions and descriptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sigint_received</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sigterm_received</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_callbacks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hello</span><span class="p">()</span></div>


<div class="viewcode-block" id="BetterLaunch.hello">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.hello">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints our welcome message and some useful information.</span>
<span class="sd">        Note that this will not appear in the logs!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ascii art based on: https://asciiart.cc/view/10677</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="se">\x1b</span><span class="s2">[1;20mBetter Launch is starting!</span><span class="se">\x1b</span><span class="s2">[0m</span>
<span class="s2">Please fasten your seatbelts and secure all baggage underneath your chair.</span>

<span class="s2">Default log level is </span><span class="se">\x1b</span><span class="s2">[34;20m</span><span class="si">{</span><span class="n">roslog</span><span class="o">.</span><span class="n">launch_config</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">roslog</span><span class="o">.</span><span class="n">launch_config</span><span class="o">.</span><span class="n">level</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\x1b</span><span class="s2">[0m</span>
<span class="s2">All log files can be found at</span>
<span class="se">\x1b</span><span class="s2">[34;20m</span><span class="si">{</span><span class="n">roslog</span><span class="o">.</span><span class="n">launch_config</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="se">\x1b</span><span class="s2">[0m</span>

<span class="s2">Takeoff in 3... 2... 1...</span>

<span class="s2">           *            ,:</span>
<span class="s2">    +                 ,&#39; |</span>
<span class="s2">               +     /   :</span>
<span class="s2">       *          --&#39;   /</span>
<span class="s2">+                </span><span class="se">\\</span><span class="s2">/ /:/</span>
<span class="s2">            *     / ://_</span><span class="se">\\</span>
<span class="s2">       +       __/   /</span>
<span class="s2">  -            )&#39;-. /</span>
<span class="s2">               ./  :</span><span class="se">\\</span>
<span class="s2">        *       /.&#39; &#39;</span>
<span class="s2">              &#39;/&#39;</span>
<span class="s2">   &#39;          +</span>
<span class="s2">           .-&quot;-</span>
<span class="s2">          (    )</span>
<span class="s2">       . .-&#39;  &#39;.</span>
<span class="s2">      ( (.   )8:</span>
<span class="s2">  .&#39; _  / (_  ) &#39;._</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="c1"># We don&#39;t want to log this</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log files at </span><span class="si">{</span><span class="n">roslog</span><span class="o">.</span><span class="n">launch_config</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.spin">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.spin">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">spin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Join the BetterLaunch thread until it terminates.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ros_adapter</span><span class="o">.</span><span class="n">_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


<div class="viewcode-block" id="BetterLaunch.get_unique_name">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.get_unique_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_unique_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a unique suffix to the provided string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The string to use as the base.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The passed in string with a unique suffix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">_uuid_generator</span><span class="p">()</span></div>


<div class="viewcode-block" id="BetterLaunch.all_groups">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.all_groups">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Group</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of all in the order they were created.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[Group]</span>
<span class="sd">            All groups added so far.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assemble all groups</span>
        <span class="n">groups</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_root</span><span class="p">]</span>
        <span class="n">queue</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_root</span><span class="p">]</span>

        <span class="c1"># Simplified breadth first search since we don&#39;t expect any loops</span>
        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">groups</span></div>


<div class="viewcode-block" id="BetterLaunch.all_nodes">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.all_nodes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_nodes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_components</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_launch_service</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">include_foreign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AbstractNode</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of all nodes in the order they were added. Components will be added right after their composers. If a ROS2 launch service has been started it will be added at the very end.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_components : bool, optional</span>
<span class="sd">            Whether to include :py:class:`Component` instances.</span>
<span class="sd">        include_launch_service : bool, optional</span>
<span class="sd">            Whether to include the ROS2 launch service wrapper if it was created.</span>
<span class="sd">        include_foreign : bool, optional</span>
<span class="sd">            Whether to include foreign nodes that have not been started by this launcher instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[AbstractNode]</span>
<span class="sd">            A list of all nodes, sorted by when they were added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_groups</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">include_components</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Composer</span><span class="p">):</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">managed_components</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_launch_service</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_foreign</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">find_foreign_nodes</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">nodes</span></div>


<div class="viewcode-block" id="BetterLaunch.query_node">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.query_node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name_regex</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_components</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">include_launch_service</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_foreign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractNode</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the first node whos :py:meth:`AbstractNode.fullname` matches the provided regex.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name_regex : str</span>
<span class="sd">            The regex to match the nodes&#39; full names against.</span>
<span class="sd">        include_components : bool, optional</span>
<span class="sd">            Whether to include components in the results, if any.</span>
<span class="sd">        include_launch_service : bool, optional</span>
<span class="sd">            Whether to include the ROS2 launch service in the result (if it exists).</span>
<span class="sd">        include_foreign : bool, optional</span>
<span class="sd">            Whether to include foreign nodes not created by this launcher.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AbstractNode</span>
<span class="sd">            The first node matching the provided regex, or None if none matched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">name_regex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">(</span>
            <span class="n">include_components</span><span class="o">=</span><span class="n">include_components</span><span class="p">,</span>
            <span class="n">include_launch_service</span><span class="o">=</span><span class="n">include_launch_service</span><span class="p">,</span>
            <span class="n">include_foreign</span><span class="o">=</span><span class="n">include_foreign</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">reg</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fullname</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">node</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BetterLaunch.query_nodes">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.query_nodes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_nodes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name_regex</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_components</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">include_launch_service</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_foreign</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AbstractNode</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve all nodes whos :py:meth:`AbstractNode.fullname` matches the provided regex.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name_regex : str</span>
<span class="sd">            The regex to match the nodes&#39; full names against.</span>
<span class="sd">        include_components : bool, optional</span>
<span class="sd">            Whether to include components in the results, if any.</span>
<span class="sd">        include_launch_service : bool, optional</span>
<span class="sd">            Whether to include the ROS2 launch service in the result (if it exists).</span>
<span class="sd">        include_foreign : bool, optional</span>
<span class="sd">            Whether to include foreign nodes not created by this launcher.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[AbstractNode]</span>
<span class="sd">            A list of all nodes matching the regex.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">name_regex</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">node</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">(</span>
                <span class="n">include_components</span><span class="o">=</span><span class="n">include_components</span><span class="p">,</span>
                <span class="n">include_launch_service</span><span class="o">=</span><span class="n">include_launch_service</span><span class="p">,</span>
                <span class="n">include_foreign</span><span class="o">=</span><span class="n">include_foreign</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">reg</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="BetterLaunch.ros_version">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.ros_version">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ros_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the name of the currently sourced ros version (i.e. *$ROS_VERSION*).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ROS_DISTRO&quot;</span><span class="p">]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">launchfile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The path of the (main) *better_launch* launchfile being executed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BetterLaunch</span><span class="o">.</span><span class="n">_launchfile</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">launch_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;All key-value pairs that have been passed to the launch function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BetterLaunch</span><span class="o">.</span><span class="n">_launch_func_args</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shared_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RosNode</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A ROS2 node instance that can be used for creating publishers, services, etc.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ros_adapter</span><span class="o">.</span><span class="n">ros_node</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">group_root</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Group</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The root group (&quot;/&quot;).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">group_tip</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Group</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The most recent group.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="BetterLaunch.find_group_for_namespace">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.find_group_for_namespace">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_group_for_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Group</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the group representing the passed namespace.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        namespace : str</span>
<span class="sd">            The namespace in question.</span>
<span class="sd">        create : bool</span>
<span class="sd">            If True, create missing groups along the way.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Group</span>
<span class="sd">            The group representing the final segment of the namespace, or None if no such group exists and create == False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">namespace</span> <span class="ow">or</span> <span class="n">namespace</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_root</span>

        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_root</span>

        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">namespace</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">create</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="n">child</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

            <span class="n">g</span> <span class="o">=</span> <span class="n">child</span>

        <span class="k">return</span> <span class="n">g</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_on_sigint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">FrameInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigint_received</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received (SIGINT), forwarding to child processes...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigint_received</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="s2">&quot;user interrupt&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received (SIGINT) again, escalating to sigterm&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_sigterm</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_sigterm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">FrameInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigterm_received</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;(SIGTERM) received again, terminating process&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sigterm_received</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using (SIGTERM) can result in orphaned processes!&quot;</span><span class="p">)</span>

        <span class="c1"># Final chance for the processes to shut down, but we will no longer wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;received (SIGTERM)&quot;</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether *better_launch* has shutdown.&quot;&quot;&quot;</span>
        <span class="c1"># TODO this is a remnant from the very beginning when we still took inspiration from ROS2 launch. Remove?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_future</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

<div class="viewcode-block" id="BetterLaunch.add_shutdown_callback">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.add_shutdown_callback">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_shutdown_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a callback which will be called when *better_launch* shuts down.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        callback : Callable</span>
<span class="sd">            The callback to call on shutdown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.shutdown">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.shutdown">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">signum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ask all nodes to shutdown and terminate the internal ROS2 thread. Any subsequent calls to BetterLaunch member functions, including this one, may fail. This will typically be called when you want to terminate your launch file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reason : str, optional</span>
<span class="sd">            A human-readable string explaining the reason for the shutdown. If not given this will be requitted with a warning.</span>
<span class="sd">        signum : int, optional</span>
<span class="sd">            The signal to send to child processes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">find_function_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shutdown was called from </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">function</span><span class="si">}</span><span class="s2">, but no reason was given&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shutdown was called without providing a reason and the calling frame could not be determined&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Tell all nodes to shut down</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">(</span>
            <span class="n">include_components</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_launch_service</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_foreign</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">signum</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> raised an exception during shutdown: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ros_adapter</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RosAdapter raised an exception during shutdown: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># If we launched extra ROS2 actions tell the launch service to shut down, too</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">signum</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ROS2 launch service raised an exception during shutdown: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Call any callbacks, but only once</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_callbacks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cb</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shutdown callback failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.find">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.find">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sbustitutions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve a path to a file or package.</span>

<span class="sd">        If the `filename` is absolute, all other arguments will be ignored and the filename will be returned.</span>

<span class="sd">        If `package` is provided, the corresponding ROS2 package path will be used as the base path. Else we attempt to locate the current launch file&#39;s package by searching its directory and parent directories for a `package.xml`. If the package cannot be determined the current working dir is used as the base path.</span>

<span class="sd">        If neither `glob` nor `filename` is provided the base path will be returned.</span>

<span class="sd">        If `filename` is provided but `glob` is not, the base path will be searched recursively for the given filename. Otherwise, `glob` will be used to locate valid candidate files and directories within the base path, allowing patterns like `**/lib` (any lib folder) and `*.py` (any python file). See the `pathlib pattern language &lt;https://docs.python.org/3/library/pathlib.html#pathlib-pattern-language&gt;`_ for details.</span>

<span class="sd">        If only `glob` is provided but not `filename`, the first candidate is returned. Otherwise the discovered candidates will be searched for the given filename.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package : str, optional</span>
<span class="sd">            Name of a ROS2 package to resolve.</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            Name of a file to look for.</span>
<span class="sd">        glob : str, optional</span>
<span class="sd">            A glob pattern to locate subdirectories and files.</span>
<span class="sd">        sbustitutions : bool, optional</span>
<span class="sd">            If True, text substitution strings within the package and base path will be resolved (see :py:meth:`resolve_string`).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            A resolved path.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `package` contains path separators, or if a `filename` is provided but could not be found within base path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sbustitutions</span><span class="p">:</span>
            <span class="n">resolve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolve</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">package</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">package</span> <span class="o">=</span> <span class="n">get_package_for_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launchfile</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">package</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">package</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="ow">in</span> <span class="n">package</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Package must be a single name, not a path&quot;</span><span class="p">)</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">get_package_prefix</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="n">base_path</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">glob</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base_path</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="p">:</span>
            <span class="n">glob</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>

        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="c1"># Return the first candidate</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
                <span class="c1"># We found a match</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

            <span class="k">elif</span> <span class="n">candidate</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="c1"># Candidate is a dir, search the filename within</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not find file or directory (filename=</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, package=</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">, glob=</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.resolve_string">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.resolve_string">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replaces a variety of special strings in the provided string, usually a path.</span>

<span class="sd">        This is similar to what ROS1 could do when resolving paths in XML launch files. Substitutions always have the form `$(&lt;substitution-type&gt; &lt;substitution-args&gt;)`. Substitutions can also be nested, so the following is possible:</span>

<span class="sd">        ``$(eval $(arg x) * 5)``  -&gt;  if x=2, this will be resolved to 10</span>

<span class="sd">        Note that the underlying algorithm will likely fail if it encounters additional brackets within the string.</span>

<span class="sd">        The following substitutions are supported:</span>
<span class="sd">        * `$(find &lt;filename&gt; &lt;package&gt; &lt;subdir&gt;)`: return the result of :py:meth:`find`. Note that substitution arguments are always sequential (not kwargs).</span>
<span class="sd">        * `$(arg &lt;name&gt; &lt;default&gt;)`: return the value of an argument passed to the launch function or `&lt;default&gt;` if it doesn&#39;t exist. Raises KeyError if no default is provided and no default was provided.</span>
<span class="sd">        * `$(param &lt;full-node-name&gt; &lt;param&gt;)`: retrieves the value of the ROS parameter `&lt;param&gt;` from the `&lt;full-node-name&gt;` (i.e. namespace + node name). Raises KeyError if the node does not exist or ValueError if the node does not have the specified parameter.</span>
<span class="sd">        * `$(env &lt;key&gt; &lt;default&gt;)`: return the value of the environment variable `&lt;key&gt;` or `&lt;default&gt;` if it doesn&#39;t exist. Raises KeyError if no default is provided and no default was provided.</span>
<span class="sd">        * `$(eval &lt;python-snippet&gt;)`: returns the result from evaluating the provided `&lt;python-snippet&gt;`. Typical use cases include simple math and assembling strings. **Note** that this indeed uses python&#39;s :py:func:`eval`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : str</span>
<span class="sd">            The string to apply substitutions to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The string with all substitutions involved.</span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError, ValueError</span>
<span class="sd">            Depending on the substitution that failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">substitute_tokens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">default_substitution_handlers</span><span class="p">(</span><span class="s2">&quot;full&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="BetterLaunch.load_params">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.load_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">configfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">node_or_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Node</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load parameters from a yaml file located through :py:meth:`find`.</span>

<span class="sd">        If the config only contains a `ros__parameters` section the entire config is returned regardless of whether `node_or_namespace` was passed. Otherwise, if `node_or_namespace` is provided, the loaded config dict is searched for a matching section. If no matching section can be found a ValueError will be raised.</span>

<span class="sd">        The following wildcards are supported for parameter sections:</span>
<span class="sd">        * `/**`: matches any number of tokens, may be followed by additional tokens and a node name</span>
<span class="sd">        * `/*`: skips a single namespace token, or ignores the node&#39;s name if at the end</span>

<span class="sd">        Note that *better_launch* could not care less whether you put `ros__parameters` in your configs - if it is there it will be silently discarded.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            `ROS2 design doc on wildcards &lt;https://github.com/ros2/design/blob/gh-pages/articles/160_ros_command_line_arguments.md#multiple-parameter-assignments&gt;`_</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package : str</span>
<span class="sd">            A package to search for the config file. May be `None` (see :py:meth:`find`).</span>
<span class="sd">        configfile : str</span>
<span class="sd">            The name of the config file to locate.</span>
<span class="sd">        subdir : str, optional</span>
<span class="sd">            A path fragment that the config file must be located in.</span>
<span class="sd">        node_or_namespace : str | Node, optional</span>
<span class="sd">            Used to specifiy which section of the config to return.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict[str, Any]</span>
<span class="sd">            The key-value pairs from the config.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the path cannot be resolved, if `node_or_namespace` is supplied and no matching section could be found, or if a substitution failed.</span>
<span class="sd">        IOError</span>
<span class="sd">            If the config file could not be read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">configfile</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;ros__parameters&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="c1"># Return the entire config if it doesn&#39;t contain sections for different nodes/namespaces</span>
            <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ros__parameters&quot;</span><span class="p">]</span>

        <span class="n">final_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">node_or_namespace</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">node_or_namespace</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">AbstractNode</span><span class="p">):</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">fullname</span>

            <span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

            <span class="c1"># See https://github.com/ros2/design/blob/gh-pages/articles/160_ros_command_line_arguments.md</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">path_to_regex</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="n">regex_parts</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">part</span> <span class="o">==</span> <span class="s2">&quot;**&quot;</span><span class="p">:</span>
                        <span class="c1"># Match any number of tokens</span>
                        <span class="n">regex_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">part</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                        <span class="c1"># Match a single token</span>
                        <span class="n">regex_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^/]+&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Regular token</span>
                        <span class="n">regex_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

                <span class="c1"># We do NOT start with a slash as only the node name could be specified</span>
                <span class="k">return</span> <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regex_parts</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span>

            <span class="c1"># According to the above design document, params files are not allowed to have nesting,</span>
            <span class="c1"># (e.g. my_namespace/: other_namespace/node: ros__parameters), so no need to delve</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">path_to_regex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">final_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="c1"># Don&#39;t break as there can be multiple matching entries due to wildcards</span>
                    <span class="c1"># See https://docs.ros.org/en/jazzy/How-To-Guides/Node-arguments.html</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_params</span><span class="p">:</span>
                <span class="c1"># We didn&#39;t find any matching parameters, so this either doesn&#39;t contain a section</span>
                <span class="c1"># for this node, or it is not a ros parameters file</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No param section matching &#39;</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No node or namespace provided, so we don&#39;t know which section we should resolve</span>
            <span class="n">final_params</span> <span class="o">=</span> <span class="n">params</span>

        <span class="c1"># Discard the ros__parameters section if it&#39;s at the root</span>
        <span class="k">if</span> <span class="s2">&quot;ros__parameters&quot;</span> <span class="ow">in</span> <span class="n">final_params</span><span class="p">:</span>
            <span class="n">final_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">final_params</span><span class="p">[</span><span class="s2">&quot;ros__parameters&quot;</span><span class="p">])</span>
            <span class="n">final_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ros__parameters&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_params</span></div>


<div class="viewcode-block" id="BetterLaunch.get_ros_message_type">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.get_ros_message_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ros_message_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a ROS2 message type from a string representation.</span>

<span class="sd">        Message representations must follow the pattern `&lt;package&gt;/&lt;type&gt;/&lt;message&gt;`, where</span>
<span class="sd">        * &lt;package&gt; is the ROS2 package that defines the message.</span>
<span class="sd">        * &lt;type&gt; is the type of message, typically one of `msg`, `srv` or `action`.</span>
<span class="sd">        * &lt;message&gt; is the name of the message itself with proper capitalization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message_string : str</span>
<span class="sd">            A message representation of the form `&lt;package&gt;/&lt;type&gt;/&lt;message&gt;`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            The message class.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ImportError</span>
<span class="sd">            If the message type could not be imported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module_name</span><span class="p">,</span> <span class="n">message_name</span> <span class="o">=</span> <span class="n">message_string</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">message_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.subscriber">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.subscriber">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">subscriber</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">message_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">qos_profile</span><span class="p">:</span> <span class="n">QoSProfile</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RosSubscriber</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a ROS2 subscriber to receive messages.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topic : str</span>
<span class="sd">            The topic to listen on for messages.</span>
<span class="sd">        message_type : str | type</span>
<span class="sd">            The type of the messages that will be received. Strings must follow the pattern `&lt;package&gt;/msg/&lt;message&gt;`.</span>
<span class="sd">        callback : Callable[[Any], Any]</span>
<span class="sd">            A function that will be called whenever a message is received.</span>
<span class="sd">        qos_profile : QoSProfile | int, optional</span>
<span class="sd">            A quality of service profile that changes how the publisher handles connections and retains data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RosSubscriber</span>
<span class="sd">            The subscriber object. Although not required for Jazzy and below, it is recommended to keep a reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">message_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ros_message_type</span><span class="p">(</span><span class="n">message_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_node</span><span class="o">.</span><span class="n">create_subscriber</span><span class="p">(</span>
            <span class="n">message_type</span><span class="p">,</span>
            <span class="n">topic</span><span class="p">,</span>
            <span class="n">callback</span><span class="p">,</span>
            <span class="n">qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.publisher">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.publisher">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">publisher</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">,</span> <span class="n">qos_profile</span><span class="p">:</span> <span class="n">QoSProfile</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RosPublisher</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a ROS2 publisher using the :py:meth:`shared_node`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topic : str</span>
<span class="sd">            The topic to publish messages on.</span>
<span class="sd">        message_type : str | type</span>
<span class="sd">            The message type that will be published. Strings must follow the pattern `&lt;package&gt;/msg/&lt;message&gt;`.</span>
<span class="sd">        qos_profile : QoSProfile | int, optional</span>
<span class="sd">            A quality of service profile that changes how the publisher handles connections and retains data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RosPublisher</span>
<span class="sd">            The publisher object. Although not required for Jazzy and below, it is recommended to keep a reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">message_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ros_message_type</span><span class="p">(</span><span class="n">message_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_node</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">message_type</span><span class="p">,</span>
            <span class="n">topic</span><span class="p">,</span>
            <span class="n">qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.publish_message">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.publish_message">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">publish_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">message_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">,</span>
        <span class="n">message_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">qos_profile</span><span class="p">:</span> <span class="n">QoSProfile</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convenience method to publish a single message. If you plan to publish additional messages, use :py:meth:`publisher` instead and use the instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topic : str</span>
<span class="sd">            The topic to publish messages on.</span>
<span class="sd">        message_type : str | type</span>
<span class="sd">            The message type that will be published. Strings must follow the pattern `&lt;package&gt;/msg/&lt;message&gt;`.</span>
<span class="sd">        message_args : dict[str, Any]</span>
<span class="sd">            The keyword arguments from which the message will be constructed.</span>
<span class="sd">        qos_profile : QoSProfile | int, optional</span>
<span class="sd">            A quality of service profile that changes how the publisher handles connections and retains data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">message_type</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ros_message_type</span><span class="p">(</span><span class="n">message_type</span><span class="p">)</span>

        <span class="n">pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">message_type</span><span class="p">,</span> <span class="n">qos_profile</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">message_type</span><span class="p">(</span><span class="o">**</span><span class="n">message_args</span><span class="p">)</span>
        <span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.service">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.service">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">service_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">qos_profile</span><span class="p">:</span> <span class="n">QoSProfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RosServiceProvider</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a ROS2 service provider using the :py:meth:`shared_node`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topic : str</span>
<span class="sd">            The topic the service will live on.</span>
<span class="sd">        service_type : str | type</span>
<span class="sd">            The service&#39;s message type. Strings must follow the pattern `&lt;package&gt;/srv/&lt;message&gt;`.</span>
<span class="sd">        callback : Callable[[Any], Any]</span>
<span class="sd">            The function that will handle any requests to the service. The type of the request will be of type `service_type.Request`.</span>
<span class="sd">        qos_profile : QoSProfile, optional</span>
<span class="sd">            A quality of service profile that changes how the service handles connections.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RosServiceProvider</span>
<span class="sd">            The service object. Although not required for Jazzy and below, it is recommended to keep a reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">service_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ros_message_type</span><span class="p">(</span><span class="n">service_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">qos_profile</span><span class="p">:</span>
            <span class="n">qos_profile</span> <span class="o">=</span> <span class="n">qos_profile_services_default</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_node</span><span class="o">.</span><span class="n">create_service</span><span class="p">(</span>
            <span class="n">service_type</span><span class="p">,</span>
            <span class="n">topic</span><span class="p">,</span>
            <span class="n">callback</span><span class="p">,</span>
            <span class="n">qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.service_client">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.service_client">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">service_client</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">service_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">qos_profile</span><span class="p">:</span> <span class="n">QoSProfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RosServiceClient</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a ROS2 service client that can be used to call a service.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topic : str</span>
<span class="sd">            The service topic to post requests on.</span>
<span class="sd">        service_type : str | type</span>
<span class="sd">            The service&#39;s message type. Strings must follow the pattern `&lt;package&gt;/srv/&lt;message&gt;`.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            Time to wait for the service to become available. Ignored if &lt;= 0.</span>
<span class="sd">        qos_profile : QoSProfile, optional</span>
<span class="sd">            A quality of service profile that changes how the service handles connections.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RosServiceClient</span>
<span class="sd">            The client object. Although not required for Jazzy and below, it is recommended to keep a reference.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            If the service did not become available within the specified timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">service_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ros_message_type</span><span class="p">(</span><span class="n">service_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">qos_profile</span><span class="p">:</span>
            <span class="n">qos_profile</span> <span class="o">=</span> <span class="n">qos_profile_services_default</span>

        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_node</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span>
            <span class="n">service_type</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">qos_profile</span><span class="o">=</span><span class="n">qos_profile</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Service client timed out (</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">service_type</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span></div>


<div class="viewcode-block" id="BetterLaunch.call_service">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.call_service">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">call_service</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">service_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">,</span>
        <span class="n">request_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">qos_profile</span><span class="p">:</span> <span class="n">QoSProfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Makes a single service request and returns the result. If you plan to make additional requests, use :py:meth:`service_client` instead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topic : str</span>
<span class="sd">            The service topic to post requests on.</span>
<span class="sd">        service_type : str | type</span>
<span class="sd">            The service&#39;s message type. Strings must follow the pattern `&lt;package&gt;/srv/&lt;message&gt;`.</span>
<span class="sd">        request_args : dict[str, Any]</span>
<span class="sd">            The keyword arguments from which the request message will be constructed.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            Time to wait for the service to become available. Ignored if &lt;= 0.</span>
<span class="sd">        qos_profile : QoSProfile, optional</span>
<span class="sd">            A quality of service profile that changes how the service handles connections.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            The result of the service call of type `service_type.Request`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            If the service did not become available within the specified timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">service_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ros_message_type</span><span class="p">(</span><span class="n">service_type</span><span class="p">)</span>

        <span class="n">srv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_client</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">service_type</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">qos_profile</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">service_type</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="o">**</span><span class="n">request_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">srv</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">req</span><span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.action_server">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.action_server">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">action_server</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">action_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">qos_profile</span><span class="p">:</span> <span class="n">QoSProfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RosActionServer&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a ROS2 action server using the :py:meth:`shared_node`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topic : str</span>
<span class="sd">            The topic namespace to provide the action interface on.</span>
<span class="sd">        action_type : str | type</span>
<span class="sd">            The type of the actions to be handled. Strings must follow the pattern `&lt;package&gt;/action/&lt;message&gt;`.</span>
<span class="sd">        callback : Callable[[Any], Any]</span>
<span class="sd">            A function that will handle incoming action requests. The type of the requests will be of type :py:func:`rclpy.action.server.ServerGoalHandle` and contain an `action_type.Goal`.</span>
<span class="sd">        qos_profile : QoSProfile, optional</span>
<span class="sd">            A quality of service profile that changes how the action server handles connections and retains data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RosActionServer</span>
<span class="sd">            The action server object. Although not required for Jazzy and below, it is recommended to keep a reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.action</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActionServer</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">action_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ros_message_type</span><span class="p">(</span><span class="n">action_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">qos_profile</span><span class="p">:</span>
            <span class="n">qos_profile</span> <span class="o">=</span> <span class="n">qos_profile_services_default</span>

        <span class="k">return</span> <span class="n">ActionServer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shared_node</span><span class="p">,</span>
            <span class="n">action_type</span><span class="p">,</span>
            <span class="n">topic</span><span class="p">,</span>
            <span class="n">callback</span><span class="p">,</span>
            <span class="n">goal_service_qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
            <span class="n">result_service_qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
            <span class="n">cancel_service_qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BetterLaunch.action_client">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.action_client">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">action_client</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">action_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">qos_profile</span><span class="p">:</span> <span class="n">QoSProfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RosActionClient&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a ROS2 action client to execute long-running actions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        topic : str</span>
<span class="sd">            The topic namespace on which the action interface is provided.</span>
<span class="sd">        action_type : str | type</span>
<span class="sd">            The type of actions the action server handles. Strings must follow the pattern `&lt;package&gt;/action/&lt;message&gt;`.</span>
<span class="sd">        timeout : float, optional</span>
<span class="sd">            Time to wait for the action server to become available. Ignored if &lt;= 0.</span>
<span class="sd">        qos_profile : QoSProfile, optional</span>
<span class="sd">            A quality of service profile that changes how the action server handles connections and retains data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RosActionClient</span>
<span class="sd">            The action client object. Although not required for Jazzy and below, it is recommended to keep a reference.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            If the action server did not become available within the specified timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Lazy import, these add a lot of overhead</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.action</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActionClient</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">action_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ros_message_type</span><span class="p">(</span><span class="n">action_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">qos_profile</span><span class="p">:</span>
            <span class="n">qos_profile</span> <span class="o">=</span> <span class="n">qos_profile_services_default</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">ActionClient</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shared_node</span><span class="p">,</span>
            <span class="n">action_type</span><span class="p">,</span>
            <span class="n">topic</span><span class="p">,</span>
            <span class="n">goal_service_qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
            <span class="n">result_service_qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
            <span class="n">cancel_service_qos_profile</span><span class="o">=</span><span class="n">qos_profile</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Action client timed out (</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">action_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span></div>


<div class="viewcode-block" id="BetterLaunch.group">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.group">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Group</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Groups are used to bundle nodes into namespaces. While they influence the nodes&#39; topics</span>
<span class="sd">        and service name, they have no runtime functionality.</span>

<span class="sd">        Groups are intended to be used as context objects and can be nested. Note that starting a</span>
<span class="sd">        new root branch (i.e. a group starting with &quot;/&quot;) is valid and will change subsequent groups</span>
<span class="sd">        for the duration of the context window.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            bl = BetterLaunch()</span>
<span class="sd">            with bl.group(&quot;outer&quot;):</span>
<span class="sd">                # Unless included in another group, &quot;outer&quot; will be attached to &quot;/&quot;</span>
<span class="sd">                with bl.group(&quot;inner/sanctum&quot;):</span>
<span class="sd">                    # Regular nesting, nodes will live within &quot;/outer/inner/sanctum&quot;</span>
<span class="sd">                    bl.node(...)</span>
<span class="sd">                with bl.group(&quot;/evil/tower&quot;):</span>
<span class="sd">                    # New root branch, nodes will live within &quot;/evil/tower&quot;</span>
<span class="sd">                    bl.node(...)</span>
<span class="sd">                # Root branch exited, nodes will live within &quot;/outer&quot; once again</span>
<span class="sd">                bl.node(...)</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            * :py:meth:`group_root`</span>
<span class="sd">            * :py:meth:`group_tip`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        namespace : str</span>
<span class="sd">            The group&#39;s namespace.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        Generator[Group, None, None]</span>
<span class="sd">            Places the group on the group stack and yields it. Exiting the context will pop the group from the group stack.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the group is created within a compose context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition_node</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot create a group inside a compose context&quot;</span><span class="p">)</span>

        <span class="c1"># It&#39;s possible to start a new root branch, especially when including launch files. Once</span>
        <span class="c1"># we exit that branch the previous stack should be restored</span>
        <span class="n">old_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_stack</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group_stack</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_root</span><span class="p">]</span>

        <span class="n">tip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_tip</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">namespace</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tip</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="n">tip</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">tip</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
                <span class="n">tip</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_group_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
            <span class="n">tip</span> <span class="o">=</span> <span class="n">branch</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">tip</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Restore the old stack.</span>
            <span class="c1"># Since it is possible to start a new root branch or open up multiple/namespaces/at/</span>
            <span class="c1"># once we replace the entire stack rather than only removing elements from the end</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group_stack</span> <span class="o">=</span> <span class="n">old_stack</span></div>


<div class="viewcode-block" id="BetterLaunch.node">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">executable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">remaps</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cmd_args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">isolate_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">LogSink</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="n">LogSink</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;screen&quot;</span><span class="p">,</span>
        <span class="n">anonymous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">on_exit</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_respawns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">respawn_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">use_shell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">autostart_process</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ros_waittime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">lifecycle_waittime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">lifecycle_target</span><span class="p">:</span> <span class="n">LifecycleStage</span> <span class="o">=</span> <span class="n">LifecycleStage</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new ROS2 node process. The bread and butter of every ROS setup!</span>

<span class="sd">        Note that this method also handles lifecycle nodes (they REALLY should have a common interface). Note that especially for lifecycle nodes you probably want `autostart_process == True`, otherwise there lifecycle management will not exist. With `autostart_process == True`, a lifecycle node will automatically advance to `lifecycle_target` once it is up. Otherwise you can also call :py:meth:`Node.start` later.</span>

<span class="sd">        The `ROS2 documentation &lt;https://docs.ros.org/en/rolling/How-To-Guides/Node-arguments.html&gt;`_ can provide some additional information regarding `params`, `remaps`, and so on.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package : str</span>
<span class="sd">            The package providing the node.</span>
<span class="sd">        executable : str</span>
<span class="sd">            The executable that should be run.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name you want the node to be known as. If `None`, a name will be derived from `package` and `executable` and `anonymous` will be set to True.</span>
<span class="sd">        remaps : dict[str, str], optional</span>
<span class="sd">            Tells the node to replace any topics it wants to interact with according to the provided dict.</span>
<span class="sd">        params : str | dict[str, Any], optional</span>
<span class="sd">            Any ROS parameters you want to pass to the node. These are the args you would typically have to declare in your launch file. A string will be interpreted as a path to a yaml file which will be lazy loaded using :py:meth:`BetterLaunch.load_params`.</span>
<span class="sd">        cmd_args : list[str], optional</span>
<span class="sd">            Additional command line arguments to pass to the node.</span>
<span class="sd">        env : dict[str, str], optional</span>
<span class="sd">            Additional environment variables to set for the node&#39;s process. The node process will merge these with the environment variables of the better_launch host process unless :py:meth:`isolate_env` is True.</span>
<span class="sd">        isolate_env : bool, optional</span>
<span class="sd">            If True, the node process&#39; env will not be inherited from the parent process and only those passed via `env` will be used. Be aware that this can result in many common things to not work anymore since e.g. keys like *PATH* will be missing.</span>
<span class="sd">        log_level : int, optional</span>
<span class="sd">            The minimum severity a logged message from this node must have in order to be published. This will be added to the cmd_args unless it is None.</span>
<span class="sd">        output : LogSink | set[LogSink], optional</span>
<span class="sd">            Determines if and where this node&#39;s output should be directed. Common choices are `screen` to print to terminal, `log` to write to a common log file, `own_log` to write to a node-specific log file, and `none` to not write any output anywhere. See :py:meth:`configure_logger` for details.</span>
<span class="sd">        anonymous : bool, optional</span>
<span class="sd">            If True, the node name will be appended with a unique suffix to avoid name conflicts.</span>
<span class="sd">        hidden : bool, optional</span>
<span class="sd">            If True, the node name will be prepended with a &quot;_&quot;, hiding it from common listings.</span>
<span class="sd">        on_exit : Callable, optional</span>
<span class="sd">            A function to call when the node&#39;s process terminates (after any possible respawns).</span>
<span class="sd">        max_respawns : int, optional</span>
<span class="sd">            How often to restart the node process if it terminates.</span>
<span class="sd">        respawn_delay : float, optional</span>
<span class="sd">            How long to wait before restarting the node process after it terminates.</span>
<span class="sd">        use_shell : bool, optional</span>
<span class="sd">            If True, invoke the node executable via the system shell. While this gives access to the shell&#39;s builtins, this has the downside of running the node inside a &quot;mystery program&quot; which is platform and user dependent. Generally not advised.</span>
<span class="sd">        autostart_process : bool, optional</span>
<span class="sd">            If True, start the node process before returning from this function.</span>
<span class="sd">        ros_waittime : float, optional</span>
<span class="sd">            How long to wait for the node to register with ROS. This should cover the time between the process starting and the node initializing itself. Set negative to wait indefinitely. Will do nothing if `autostart_process` is False.</span>
<span class="sd">        lifecycle_waittime : float, optional</span>
<span class="sd">            How long to wait for the node&#39;s lifecycle management to come up. This should cover the time between the node initializing itself (see `ros_waittime`) and creating its additional topics and services. While neglible on modern computers, slower devices and embedded systems may experience a noticable delay here. Set negative to wait indefinitely. Will do nothing if `autostart_process` is False.</span>
<span class="sd">        lifecycle_target : LifecycleStage, optional</span>
<span class="sd">            The lifecycle stage to bring the node into after starting. Has no effect if `autostart_process` is False or if the node does not appear to be a lifecycle node after waiting `ros_waittime + lifecycle_waittime`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Node</span>
<span class="sd">            The node object wrapping the node process.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If you try to add a node withing a :py:meth:`compose` context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition_node</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot add nodes inside a composition node&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">executable</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">anonymous</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">anonymous</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unique_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hidden</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_tip</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">assemble_namespace</span><span class="p">()</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="p">,</span>
            <span class="n">executable</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">namespace</span><span class="p">,</span>
            <span class="n">remaps</span><span class="o">=</span><span class="n">remaps</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">cmd_args</span><span class="o">=</span><span class="n">cmd_args</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">isolate_env</span><span class="o">=</span><span class="n">isolate_env</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="n">on_exit</span><span class="o">=</span><span class="n">on_exit</span><span class="p">,</span>
            <span class="n">max_respawns</span><span class="o">=</span><span class="n">max_respawns</span><span class="p">,</span>
            <span class="n">respawn_delay</span><span class="o">=</span><span class="n">respawn_delay</span><span class="p">,</span>
            <span class="n">use_shell</span><span class="o">=</span><span class="n">use_shell</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">autostart_process</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">check_ros2_connected</span><span class="p">(</span><span class="n">ros_waittime</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">check_lifecycle_node</span><span class="p">(</span><span class="n">lifecycle_waittime</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">lifecycle</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="n">lifecycle_target</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="BetterLaunch.compose">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.compose">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compose</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpp&quot;</span><span class="p">,</span>
        <span class="n">variant</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;multithreading&quot;</span><span class="p">,</span> <span class="s2">&quot;isolated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">reuse_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">component_remaps</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">anonymous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">autostart_process</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ros_waittime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">LogSink</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="n">LogSink</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;screen&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Composer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a composer node which can be used to load :py:class:`Component`s. Components can be instantiated directly, or preferably via :py:meth:`component`. Only components can reside within a composer.</span>

<span class="sd">        Existing composers can be reused even if they have been created outside of *better_launch*. See :py:class:`Composer` for further details.</span>

<span class="sd">        This method should be used as a context, e.g.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            bl = BetterLaunch()</span>
<span class="sd">            with bl.compose(&quot;my-composer&quot;):</span>
<span class="sd">                bl.component(&quot;my_package&quot;, &quot;mystuff:TheComponentOfDreams&quot;, &quot;normal-component&quot;)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name you want the composer to be known as. `anonymous` will be set to True if no name is provided.</span>
<span class="sd">        language : str, optional</span>
<span class="sd">            The implementation of the standard composer you want to use. Ignored if `reuse_existing` is True and a matching node is found.</span>
<span class="sd">        variant : Literal[&quot;normal&quot;, &quot;multithreading&quot;, &quot;isolated&quot;], optional</span>
<span class="sd">            ROS2 provides special composers for components that need multithreading or should be isolated from the rest. Ignored if `reuse_existing` is True and a matching node is found.</span>
<span class="sd">        reuse_existing : bool, optional</span>
<span class="sd">            If True and a node matching the current namespace and provided name is found, it will be used instead of creating a new node. This will even work for composers not created through better_launch, although in that case it won&#39;t be possible to stop them.</span>
<span class="sd">        component_remaps : dict[str, str], optional</span>
<span class="sd">            Any remaps you want to apply to all *components* loaded into this composer.</span>
<span class="sd">        anonymous : bool, optional</span>
<span class="sd">            If True, the composer name will be appended with a unique suffix to avoid name conflicts. `reuse_existing` will be set to False in this case.</span>
<span class="sd">        hidden : bool, optional</span>
<span class="sd">            If True, the composer name will be prepended with a &quot;_&quot;, hiding it from common listings.</span>
<span class="sd">        autostart_process : bool, optional</span>
<span class="sd">            If True, start the composer process before returning from this function. Note that setting this to False for a composer will make it unusable as a context object, since you won&#39;t be able to load any components.</span>
<span class="sd">        ros_waittime : float, optional</span>
<span class="sd">            How long to wait for the composer to register with ROS. This should cover the time between the process starting and the composer initializing itself. Set negative to wait indefinitely. Will do nothing if `autostart_process` is False.</span>
<span class="sd">        output : LogSink | set[LogSink], optional</span>
<span class="sd">            Determines if and where this node&#39;s output should be directed. Common choices are `screen` to print to terminal, `log` to write to a common log file, `own_log` to write to a node-specific log file, and `none` to not write any output anywhere. See :py:meth:`configure_logger` for details.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        Generator[Composer, None, None]</span>
<span class="sd">            Sets the composition flag and yields the composer.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If you try to create a composer within a :py:func:`compose` context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot nest composition nodes&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;composer&quot;</span>
            <span class="n">anonymous</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">anonymous</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unique_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">reuse_existing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">hidden</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_tip</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">assemble_namespace</span><span class="p">()</span>

        <span class="n">node_ref</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">reuse_existing</span><span class="p">:</span>
            <span class="c1"># Try to find an already running node we can reuse</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">fullname</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">ns</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="k">if</span> <span class="n">ns</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span>

            <span class="c1"># Check if it&#39;s a node we&#39;ve created</span>
            <span class="n">node_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_node</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">include_components</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">node_ref</span><span class="p">:</span>
                <span class="c1"># Otherwise see if there&#39;s a foreign node matching the full name</span>
                <span class="n">living_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="n">_ns</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">_ns</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_name</span>
                    <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_ns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_node</span><span class="o">.</span><span class="n">get_node_names_and_namespaces</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">living_nodes</span><span class="p">:</span>
                    <span class="n">node_processes</span> <span class="o">=</span> <span class="n">find_process_for_node</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">node_processes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Could not identify process for node </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">, creating new composer&quot;</span><span class="p">,</span>
                            <span class="n">namespace</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_processes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Found multiple node processes matching </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">, using most recent&quot;</span><span class="p">,</span>
                            <span class="n">namespace</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">node_ref</span> <span class="o">=</span> <span class="n">ForeignNode</span><span class="o">.</span><span class="n">wrap_process</span><span class="p">(</span><span class="n">node_processes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node_ref</span> <span class="o">=</span> <span class="n">ForeignNode</span><span class="o">.</span><span class="n">wrap_process</span><span class="p">(</span><span class="n">node_processes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">node_ref</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Composer</span><span class="o">.</span><span class="n">is_composer</span><span class="p">(</span><span class="n">node_ref</span><span class="p">):</span>
            <span class="c1"># We will still reuse it but raise some awareness</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reused composer node </span><span class="si">{</span><span class="n">node_ref</span><span class="o">.</span><span class="n">fullname</span><span class="si">}</span><span class="s2"> does not provide the expected services (yet)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_ref</span><span class="p">:</span>
            <span class="c1"># Node doesn&#39;t exist yet or it should not be reused, create a new composer</span>
            <span class="n">package</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rcl</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2">_components&quot;</span>

            <span class="c1"># The actual implementation of the composer</span>
            <span class="k">if</span> <span class="n">variant</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                <span class="n">executable</span> <span class="o">=</span> <span class="s2">&quot;component_container&quot;</span>
            <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s2">&quot;multithreading&quot;</span><span class="p">:</span>
                <span class="n">executable</span> <span class="o">=</span> <span class="s2">&quot;component_container_mt&quot;</span>
            <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s2">&quot;isolated&quot;</span><span class="p">:</span>
                <span class="n">executable</span> <span class="o">=</span> <span class="s2">&quot;component_container_isolated&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown container mode &#39;</span><span class="si">{</span><span class="n">variant</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">node_ref</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_ref</span><span class="p">,</span> <span class="n">Composer</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">node_ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">Composer</span><span class="p">(</span><span class="n">node_ref</span><span class="p">,</span> <span class="n">component_remaps</span><span class="o">=</span><span class="n">component_remaps</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">autostart_process</span><span class="p">:</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">service_timeout</span><span class="o">=</span><span class="n">ros_waittime</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_composition_node</span> <span class="o">=</span> <span class="n">comp</span>
            <span class="k">yield</span> <span class="n">comp</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_composition_node</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BetterLaunch.component">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.component">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">component</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">remaps</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">anonymous</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_intra_process_comms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ros_waittime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">lifecycle_waittime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">lifecycle_target</span><span class="p">:</span> <span class="n">LifecycleStage</span> <span class="o">=</span> <span class="n">LifecycleStage</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">LogSink</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="n">LogSink</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;screen&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">extra_composer_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Component</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a component and load it into an existing :py:meth:`compose` context.</span>

<span class="sd">        If you instead want to load components without a `compose` context, you should instantiate :py:class:`Component` objects directly, then load them via :py:meth:`Component.start` or :py:meth:`Composer.load_component`. See the examples for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package : str</span>
<span class="sd">            The package providing the component implementation.</span>
<span class="sd">        plugin : str</span>
<span class="sd">            The name the component is registered as, typically of the form `&lt;package&gt;::&lt;Name&gt;`.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name the instantiated component should be known as. If `None`, a name will be derived from `package` and `plugin`, and `anonymous` will be set to True.</span>
<span class="sd">        remaps : dict[str, str], optional</span>
<span class="sd">            Tells the node to replace any topics it wants to interact with according to the provided dict.</span>
<span class="sd">        anonymous : bool, optional</span>
<span class="sd">            If True, the composer name will be appended with a unique suffix to avoid name conflicts.</span>
<span class="sd">        hidden : bool, optional</span>
<span class="sd">            If True, the composer name will be prepended with a &quot;_&quot;, hiding it from common listings.</span>
<span class="sd">        params : str | dict[str, Any], optional</span>
<span class="sd">            Any ROS parameters you want to pass to the component. These are the args you would typically have to declare in your launch file. A string will be interpreted as a path to a yaml file which will be lazy loaded using :py:meth:`BetterLaunch.load_params`.</span>
<span class="sd">        use_intra_process_comms : bool, optional</span>
<span class="sd">            If True, ask the composer node to enable intra-process communication, i.e. share memory between components when passing messages instead of serializing and deserializing.</span>
<span class="sd">        ros_waittime : float, optional</span>
<span class="sd">            How long to wait for the component to register with ROS. This should cover the time between the process starting and the component initializing itself. Set negative to wait indefinitely. Will do nothing if `autostart_process` is False.</span>
<span class="sd">        lifecycle_waittime : float, optional</span>
<span class="sd">            How long to wait for the component&#39;s lifecycle management to come up. This should cover the time between the component initializing itself (see `ros_waittime`) and creating its additional topics and services. While neglible on modern computers, slower devices and embedded systems may experience a noticable delay here. Set negative to wait indefinitely. Will do nothing if `autostart_process` is False.</span>
<span class="sd">        lifecycle_target : LifecycleStage, optional</span>
<span class="sd">            The lifecycle stage to bring the component into after starting. Has no effect if `autostart_process` is False or if the component does not appear to be a lifecycle component after waiting `ros_waittime + lifecycle_waittime`.</span>
<span class="sd">        output : LogSink | set[LogSink], optional</span>
<span class="sd">            Determines if and where this node&#39;s output should be directed. Common choices are `screen` to print to terminal, `log` to write to a common log file, `own_log` to write to a node-specific log file, and `none` to not write any output anywhere. See :py:meth:`configure_logger` for details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Component</span>
<span class="sd">            The component that has been loaded into the current :py:meth:`compose` context.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If this is called outside a :py:meth:`compose` context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot add component outside a compose() node&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">plugin</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">anonymous</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">anonymous</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unique_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hidden</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_tip</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">assemble_namespace</span><span class="p">()</span>

        <span class="n">comp</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_composition_node</span><span class="p">,</span>
            <span class="n">package</span><span class="p">,</span>
            <span class="n">plugin</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">namespace</span><span class="p">,</span>
            <span class="n">remaps</span><span class="o">=</span><span class="n">remaps</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Equivalent to self._composition_node.load_component(comp)</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
            <span class="n">use_intra_process_comms</span><span class="o">=</span><span class="n">use_intra_process_comms</span><span class="p">,</span>
            <span class="o">**</span><span class="n">extra_composer_args</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">check_ros2_connected</span><span class="p">(</span><span class="n">ros_waittime</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">check_lifecycle_node</span><span class="p">(</span><span class="n">lifecycle_waittime</span><span class="p">):</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">lifecycle</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="n">lifecycle_target</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">comp</span></div>


<div class="viewcode-block" id="BetterLaunch.include">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.include">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">include</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">launchfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">pass_launch_func_args</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Include another launch file, resolving its path using :py:meth:`find`.</span>

<span class="sd">        The file is first read into memory and checked. If it seems to be a *better_launch* launch file, it is executed immediately (using :py:func:`exec`). The BetterLaunch instance and global context will be shared. Any arguments to :py:meth:`launch_this` in the included launch file will be ignored.</span>

<span class="sd">        If the file does not appear to be a *better_launch* launch file, it is assumed to be a regular ROS2 launch file. In this case a :py:class:`launch.actions.IncludeLaunchDescription` instance is created and passed to :py:meth:`ros2_actions`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        package : str</span>
<span class="sd">            The package containing the specified launch file. May be `None` (see :py:meth:`find`).</span>
<span class="sd">        launchfile : str</span>
<span class="sd">            The name of a launch file to execute.</span>
<span class="sd">        subdir : str, optional</span>
<span class="sd">            A path fragment the launch file must be located in.</span>
<span class="sd">        pass_launch_func_args : bool, optional</span>
<span class="sd">            If True, all :py:meth:`launch_args` will be passed to the included launch file. Additional launch arguments can also be provided via the `kwargs`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the passed in `search_args` cannot be handled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">launchfile</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>

        <span class="c1"># Pass additional arguments, e.g. launch args</span>
        <span class="n">include_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">pass_launch_func_args</span><span class="p">:</span>
            <span class="n">include_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launch_args</span><span class="p">)</span>
        <span class="n">include_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">find_launchthis_function</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">launchfile</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">)</span>

                <span class="c1"># Make sure the included launch file reuses our BetterLaunch instance</span>
                <span class="n">global_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="p">())</span>
                <span class="n">global_args</span><span class="p">[</span><span class="n">_bl_singleton_instance</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="n">global_args</span><span class="p">[</span><span class="n">_bl_include_args</span><span class="p">]</span> <span class="o">=</span> <span class="n">include_args</span>

                <span class="c1"># Since we&#39;re running an entire module locals won&#39;t have any effect</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">global_args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Launch include &#39;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">launchfile</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Was not a better_launch launch file, assume it&#39;s a ROS2 launch file (py, xml, yaml)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_include_ros2_launchfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="o">**</span><span class="n">include_args</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_include_ros2_launchfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Delegate to ros2 launch service</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">launch.launch_description_sources</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">AnyLaunchDescriptionSource</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># See https://github.com/ros2/launch_ros/blob/rolling/ros2launch/ros2launch/api/api.py#L175</span>
        <span class="n">ros2_include</span> <span class="o">=</span> <span class="n">IncludeLaunchDescription</span><span class="p">(</span>
            <span class="n">AnyLaunchDescriptionSource</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
            <span class="n">launch_arguments</span><span class="o">=</span><span class="p">[</span>
                <span class="c1"># ROS2 can handle only tuples of strings and strings/substitutions here...</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ros2_actions</span><span class="p">(</span><span class="n">ros2_include</span><span class="p">)</span>

<div class="viewcode-block" id="BetterLaunch.ros2_launch_service">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.ros2_launch_service">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ros2_launch_service</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;LaunchService&quot;</span><span class="p">,</span>
        <span class="n">launchservice_args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">LogSink</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="n">LogSink</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;screen&quot;</span><span class="p">,</span>
        <span class="n">start_immediately</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ros2LaunchWrapper</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create or retrieve a manager object that can be used for queueing ROS2 launch actions.</span>

<span class="sd">        Usually, calling :py:meth:`ros2_actions` is more convenient for queueing actions. However, calling this *first* allows to prevent starting the underlying :py:class:`launch.LaunchService` immediately, giving more control over when the actions are executed.</span>

<span class="sd">        Since the `LaunchService` insists on running on the main thread it will be started as a sub process.</span>

<span class="sd">        Note that only one instance of the ROS2 wrapper should ever exist. Calling this method after it has been created will return the already existing instance instead. Any passed arguments will be silently discarded.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name used to identify the process and its logger.</span>
<span class="sd">        launchservice_args : list[str], optional</span>
<span class="sd">            Additional launch arguments to pass to the ROS2 launch service. These will end up in :py:meth:`launch.LaunchContext.argv`.</span>
<span class="sd">        output : LogSink  |  set[LogSink], optional</span>
<span class="sd">            How log output from the launch service should be handled. This will also include the output from all nodes launched by this launch service. Common choices are `screen` to print to terminal, `log` to write to a common log file, `own_log` to write to a node-specific log file, and `none` to not write any output anywhere. See :py:meth:`configure_logger` for details.</span>
<span class="sd">        start_immediately : bool, optional</span>
<span class="sd">            If True, the ROS2 launch service process is started immediately.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Ros2LaunchWrapper</span>
<span class="sd">            The wrapper hosting the ROS2 launch service process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span> <span class="o">=</span> <span class="n">Ros2LaunchWrapper</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">launchservice_args</span><span class="o">=</span><span class="n">launchservice_args</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">start_immediately</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span></div>


<div class="viewcode-block" id="BetterLaunch.ros2_actions">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.ros2_actions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ros2_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ros2_actions</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ros2LaunchWrapper</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Submit additional ROS2 launch actions for execution.</span>

<span class="sd">        If no :py:class:`launch.LaunchService` exists yet it will be created and started immediately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ros2_launch_service</span><span class="p">()</span><span class="o">.</span><span class="n">queue_ros2_actions</span><span class="p">(</span><span class="o">*</span><span class="n">ros2_actions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ros2_launcher</span></div>


<div class="viewcode-block" id="BetterLaunch.run_later">
<a class="viewcode-back" href="../../better_launch_custom.html#better_launch.launcher.BetterLaunch.run_later">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_later</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convenience method for running a callback with a delay. The callback will be called on a separte thread.</span>

<span class="sd">        This mainly exists to cover the use case where you want to interact with ROS from an `rclpy.Timer`. A synchronous call from within a timer (e.g. a service call like :py:meth:`Node.set_live_params`) will block ROS&#39; background event loop, preventing publishers, subscribers, services, etc. from doing their work. It will also prevent a clean shutdown as ROS usually waits for the event queue to become empty.</span>

<span class="sd">        When executing a long running task this way it is a good idea to check :py:meth:`is_shutdown` in between iterations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delay : float</span>
<span class="sd">            How long to wait in seconds before calling the callback.</span>
<span class="sd">        callback : Callable</span>
<span class="sd">            The function to call after the timeout. Will not be called if :py:meth:`shutdown` is called beforehand.</span>
<span class="sd">        *args : Any, optional</span>
<span class="sd">            Positional arguments to the callback.</span>
<span class="sd">        **kwargs : Any, optional</span>
<span class="sd">            Keyword arguments to the callback.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Future</span>
<span class="sd">            A future which will be cancelled on `shutdown`, otherwise it will hold the callback&#39;s result or an exception the callback raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">:</span>
                <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># TODO this is a good candidate for running on an asyncio loop</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">future</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Nikolas Dahn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>